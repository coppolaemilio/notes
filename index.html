<html>
  <head>
    <meta charset="utf-8" />
    <meta name="theme-color" content="#ffc623">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./images/touch/favicon-32-32.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/touch/favicon-32-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./images/touch/favicon-16-16.png">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="./main.css" />
    <title>Notes</title>
  </head>
  <body>
    <nav class="main">Notes</nav>
    <div class="container">
      <input class="new-note" type="text" placeholder="Write note...">
    </div>
    <section class="board"></section>
<script>
// Functions
function stripHtml(html) {
  var tmp = document.createElement("DIV");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}

function createNote(text) {
  // Template
  var template = '<p contenteditable="true" spellcheck="false" onblur="checkAndDeleteEmptyNotes()">{{ note_content }}</p>';
  // Element
  var wrapper = document.createElement('div');
  wrapper.className = "note";
  wrapper.innerHTML = template.replace('{{ note_content }}', text);
  return wrapper;
}

// Loading data
var notes = [];
if (localStorage.getItem('notesData') !== undefined) {
  var notes = localStorage.getItem('notesData').split('{/}'); 
}

// Creating the html for the notes
for (i = 0; i < notes.length; i++) {
  if (notes[i] !== '') {
    var note = createNote(notes[i]);
    
    // Adding the notes to the board
    var board = document.querySelector(".board");
    board.insertBefore(note, board.firstChild);
  }
}

// Saving data
setInterval(function() {
  var notesData = '';
  var divs = document.querySelectorAll("div.note");
  for (var i = 0; i < divs.length; i++) {
    var currentDiv = divs[i];
    notesData = currentDiv.firstChild.innerHTML + '{/}' + notesData;
  }
  console.log(notesData);
  localStorage.setItem('notesData', notesData);
}, 1000);



// Removing note
function checkAndDeleteEmptyNotes(){
  var divs = document.querySelectorAll("div.note");
  for (var i = 0; i < divs.length; i++){
    var currentDiv = divs[i];
    var parsedText = stripHtml(currentDiv.firstChild.innerHTML);

    if (parsedText == '') {
      if (currentDiv.firstChild !== document.activeElement) {
        currentDiv.parentElement.removeChild(currentDiv);
      }
    }
  }
}

// Key up event and updates
document.onkeyup = keyup;
function keyup(event){
  var keyCode = event.which;
  console.log(keyCode);
  if (keyCode==13) {
    console.log('enter!');
  }
  
  checkAndDeleteEmptyNotes();

  // Creating note
  var newNoteInput = document.querySelector('.new-note');
  if (newNoteInput.value != '') {
    var note = createNote(newNoteInput.value);
    var board = document.querySelector(".board");
    newNoteInput.value = '';
    board.insertBefore(note, board.firstChild);
  }
}

/*
Todo:
- export/import data
- order notes
- sync notes
- search notes
- return error if exceeding the localstorage limit
*/

</script>
  </body>
</html>